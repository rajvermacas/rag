<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RAG Document Chat</title>
  <link rel="stylesheet" href="/static/css/output.css" />
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.2.6/dist/purify.min.js"></script>
</head>
<body class="min-h-screen bg-zinc-100 text-zinc-900">
  <main class="mx-auto max-w-6xl px-4 py-8 md:py-12">
    <header class="mb-8 rounded-2xl border border-zinc-200 bg-white/90 p-6 shadow-xl shadow-zinc-300/40 backdrop-blur">
      <div class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
        <div>
          <p class="text-xs font-semibold uppercase tracking-[0.2em] text-red-600">RAG Workspace</p>
          <h1 class="text-3xl font-black tracking-tight text-zinc-950 md:text-4xl">Document Intelligence Chat</h1>
          <p class="mt-2 max-w-2xl text-sm text-zinc-600">
            Upload files, chat with grounded answers, review citations, and manage indexed documents in one workspace.
          </p>
        </div>
      </div>
    </header>

    <section class="rounded-2xl border border-zinc-200 bg-white shadow-xl shadow-zinc-300/30">
      <nav class="flex flex-wrap items-center gap-2 border-b border-zinc-200 p-4">
        <button
          id="nav-chat"
          class="rounded-lg border border-zinc-300 bg-zinc-900 px-4 py-2 text-sm font-semibold text-white transition hover:bg-zinc-800"
          type="button"
        >
          Chat
        </button>
        <button
          id="nav-documents"
          class="rounded-lg border border-zinc-300 bg-white px-4 py-2 text-sm font-semibold text-zinc-700 transition hover:border-red-500 hover:text-red-600"
          type="button"
        >
          Documents
        </button>
        <p class="ml-auto text-xs text-zinc-500">Palette: Red, Gray, Black, White</p>
      </nav>

      <section id="chat-panel" class="grid gap-6 p-4 md:grid-cols-[minmax(20rem,24rem)_1fr] md:p-6">
        <article class="rounded-xl border border-zinc-200 bg-zinc-50 p-4">
          <h2 class="text-lg font-bold text-zinc-950">Upload Document</h2>
          <p class="mt-1 text-sm text-zinc-600">Accepted formats: PDF, DOCX, TXT.</p>
          <form id="upload-form" class="mt-4 space-y-3">
            <input
              class="w-full rounded-lg border border-zinc-300 bg-white px-3 py-2 text-sm text-zinc-900 file:mr-3 file:rounded-md file:border-0 file:bg-red-600 file:px-3 file:py-2 file:text-sm file:font-semibold file:text-white hover:file:bg-red-700"
              type="file"
              name="file"
              accept=".pdf,.docx,.txt"
              required
            />
            <button
              id="upload-button"
              class="inline-flex w-full items-center justify-center rounded-lg border border-red-700 bg-red-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-red-700 disabled:cursor-not-allowed disabled:opacity-60"
              type="submit"
            >
              <span
                id="upload-loader"
                class="mr-2 hidden h-4 w-4 animate-spin rounded-full border-2 border-white border-t-transparent"
                aria-hidden="true"
              ></span>
              <span id="upload-button-label">Upload</span>
            </button>
          </form>
          <p id="upload-status" class="mt-3 text-sm text-zinc-700"></p>
        </article>

        <article class="rounded-xl border border-zinc-200 bg-white p-4">
          <h2 class="text-lg font-bold text-zinc-950">Chat</h2>
          <div class="mt-3 flex flex-col gap-2 sm:flex-row sm:items-center">
            <label for="chat-history-select" class="text-sm font-semibold text-zinc-700">Chat History</label>
            <select
              id="chat-history-select"
              class="rounded-lg border border-zinc-300 bg-white px-3 py-2 text-sm text-zinc-900 outline-none transition focus:border-red-500 focus:ring-2 focus:ring-red-500/20"
            ></select>
            <button
              id="clear-chat"
              class="rounded-lg border border-zinc-300 bg-white px-3 py-2 text-sm font-semibold text-zinc-700 transition hover:border-red-500 hover:text-red-600 sm:ml-auto"
              type="button"
            >
              Clear Chat
            </button>
          </div>
          <div
            id="chat-window"
            class="mt-3 h-[30rem] overflow-y-auto rounded-xl border border-zinc-200 bg-zinc-50 p-3"
          ></div>
          <form id="chat-form" class="mt-4 flex flex-col gap-3 sm:flex-row">
            <input
              class="flex-1 rounded-lg border border-zinc-300 bg-white px-3 py-2 text-sm text-zinc-900 outline-none transition focus:border-red-500 focus:ring-2 focus:ring-red-500/20"
              type="text"
              name="message"
              placeholder="Ask a question about uploaded documents..."
              required
            />
            <button
              id="chat-button"
              class="inline-flex items-center justify-center rounded-lg border border-zinc-900 bg-zinc-900 px-4 py-2 text-sm font-semibold text-white transition hover:bg-zinc-800 disabled:cursor-not-allowed disabled:opacity-60"
              type="submit"
            >
              Send
            </button>
          </form>
        </article>
      </section>

      <section id="documents-panel" class="hidden space-y-4 p-4 md:p-6">
        <div class="flex items-center justify-between">
          <div>
            <h2 class="text-lg font-bold text-zinc-950">Indexed Documents</h2>
            <p class="text-sm text-zinc-600">Delete a document to remove its indexed chunks from retrieval.</p>
          </div>
          <button
            id="refresh-documents"
            class="rounded-lg border border-zinc-300 bg-white px-4 py-2 text-sm font-semibold text-zinc-700 transition hover:border-red-500 hover:text-red-600"
            type="button"
          >
            Refresh
          </button>
        </div>
        <div class="overflow-hidden rounded-xl border border-zinc-200">
          <table class="w-full border-collapse bg-white text-sm">
            <thead class="bg-zinc-100 text-left text-xs uppercase tracking-wide text-zinc-600">
              <tr>
                <th class="px-4 py-3">Filename</th>
                <th class="px-4 py-3">Document ID</th>
                <th class="px-4 py-3">Chunks</th>
                <th class="px-4 py-3 text-right">Action</th>
              </tr>
            </thead>
            <tbody id="documents-table-body" class="divide-y divide-zinc-200"></tbody>
          </table>
        </div>
        <p id="documents-status" class="text-sm text-zinc-700"></p>
      </section>
    </section>
  </main>

  <script>
    if (typeof marked === "undefined") {
      throw new Error("marked is required for markdown rendering");
    }
    if (typeof DOMPurify === "undefined") {
      throw new Error("DOMPurify is required for markdown rendering");
    }

    const uploadForm = requireElement("upload-form");
    const uploadButton = requireElement("upload-button");
    const uploadLoader = requireElement("upload-loader");
    const uploadButtonLabel = requireElement("upload-button-label");
    const uploadStatus = requireElement("upload-status");
    const chatForm = requireElement("chat-form");
    const chatButton = requireElement("chat-button");
    const chatWindow = requireElement("chat-window");
    const chatHistorySelect = requireElement("chat-history-select");
    const clearChatButton = requireElement("clear-chat");
    const navChat = requireElement("nav-chat");
    const navDocuments = requireElement("nav-documents");
    const chatPanel = requireElement("chat-panel");
    const documentsPanel = requireElement("documents-panel");
    const refreshDocuments = requireElement("refresh-documents");
    const documentsTableBody = requireElement("documents-table-body");
    const documentsStatus = requireElement("documents-status");
    const chatSessions = [];
    let activeSessionId = "";
    let conversationHistory = [];

    marked.setOptions({
      breaks: true,
      gfm: true,
    });

    navChat.addEventListener("click", () => switchPanel("chat"));
    navDocuments.addEventListener("click", () => switchPanel("documents"));
    refreshDocuments.addEventListener("click", async () => {
      await loadDocuments();
    });
    chatHistorySelect.addEventListener("change", () => {
      const selectedSessionId = chatHistorySelect.value;
      setActiveSession(selectedSessionId);
      renderChatHistoryOptions();
      renderActiveSessionMessages();
    });
    clearChatButton.addEventListener("click", () => {
      clearActiveChat();
    });

    uploadForm.addEventListener("submit", async (event) => {
      event.preventDefault();
      uploadButton.disabled = true;
      setUploadButtonLoadingState(true);
      uploadStatus.textContent = "Uploading document...";
      try {
        const formData = new FormData(uploadForm);
        const response = await fetch("/upload", {
          method: "POST",
          body: formData,
        });
        const payload = await response.json();
        if (!response.ok) {
          uploadStatus.textContent = `Upload failed: ${requireString(payload, "detail", "upload error")}`;
          return;
        }
        requireString(payload, "doc_id", "upload response");
        requireNumber(payload, "chunks_indexed", "upload response");
        uploadStatus.textContent = "Upload successful";
        uploadForm.reset();
        await loadDocuments();
      } finally {
        uploadButton.disabled = false;
        setUploadButtonLoadingState(false);
      }
    });

    chatForm.addEventListener("submit", async (event) => {
      event.preventDefault();
      chatButton.disabled = true;
      try {
        const formData = new FormData(chatForm);
        const rawMessage = formData.get("message");
        if (typeof rawMessage !== "string") {
          throw new Error("message field is required");
        }
        const message = rawMessage.trim();
        if (message === "") {
          return;
        }

        appendUserMessage(message);
        conversationHistory.push({ role: "user", message });
        chatForm.reset();

        const response = await fetch("/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message, history: conversationHistory }),
        });
        const payload = await response.json();
        if (!response.ok) {
          appendSystemError(requireString(payload, "detail", "chat error"));
          return;
        }

        const answer = requireString(payload, "answer", "chat response");
        appendAssistantMessage(answer);
        conversationHistory.push({ role: "assistant", message: answer });
      } finally {
        chatButton.disabled = false;
      }
    });

    window.addEventListener("load", async () => {
      initializeChatSessions();
      appendAssistantMessage(
        "Hello. I can answer questions from uploaded files, and you can check the **Documents** tab to manage indexing."
      );
      await loadDocuments();
    });

    function requireElement(id) {
      const element = document.getElementById(id);
      if (element === null) {
        throw new Error(`missing required element: ${id}`);
      }
      return element;
    }

    function requireString(record, key, context) {
      if (!(key in record)) {
        throw new Error(`missing '${key}' in ${context}`);
      }
      const value = record[key];
      if (typeof value !== "string") {
        throw new Error(`'${key}' must be a string in ${context}`);
      }
      return value;
    }

    function requireNumber(record, key, context) {
      if (!(key in record)) {
        throw new Error(`missing '${key}' in ${context}`);
      }
      const value = record[key];
      if (typeof value !== "number") {
        throw new Error(`'${key}' must be a number in ${context}`);
      }
      return value;
    }

    function setUploadButtonLoadingState(isLoading) {
      if (typeof isLoading !== "boolean") {
        throw new Error("upload loading state must be a boolean");
      }
      if (isLoading) {
        uploadLoader.classList.remove("hidden");
        uploadButtonLabel.textContent = "Uploading...";
        return;
      }
      uploadLoader.classList.add("hidden");
      uploadButtonLabel.textContent = "Upload";
    }

    function switchPanel(target) {
      if (target === "chat") {
        chatPanel.classList.remove("hidden");
        documentsPanel.classList.add("hidden");
        navChat.classList.remove("bg-white", "text-zinc-700");
        navChat.classList.add("bg-zinc-900", "text-white");
        navDocuments.classList.remove("bg-zinc-900", "text-white");
        navDocuments.classList.add("bg-white", "text-zinc-700");
        return;
      }
      if (target === "documents") {
        documentsPanel.classList.remove("hidden");
        chatPanel.classList.add("hidden");
        navDocuments.classList.remove("bg-white", "text-zinc-700");
        navDocuments.classList.add("bg-zinc-900", "text-white");
        navChat.classList.remove("bg-zinc-900", "text-white");
        navChat.classList.add("bg-white", "text-zinc-700");
        return;
      }
      throw new Error(`unknown panel target: ${target}`);
    }

    function renderMarkdown(markdownText) {
      const html = marked.parse(markdownText);
      return DOMPurify.sanitize(html);
    }

    function initializeChatSessions() {
      const session = createChatSession("Current Chat");
      chatSessions.push(session);
      setActiveSession(session.id);
      renderChatHistoryOptions();
      renderActiveSessionMessages();
    }

    function createChatSession(label) {
      if (typeof label !== "string" || label.trim() === "") {
        throw new Error("chat session label is required");
      }
      return {
        id: createSessionId(),
        label,
        history: [],
        messages: [],
      };
    }

    function createSessionId() {
      if (typeof crypto === "undefined" || typeof crypto.randomUUID !== "function") {
        throw new Error("crypto.randomUUID is required for chat sessions");
      }
      return crypto.randomUUID();
    }

    function clearActiveChat() {
      const activeSession = getActiveSession();
      if (activeSession.messages.length === 0 && activeSession.history.length === 0) {
        return;
      }
      activeSession.label = `Chat ${new Date().toLocaleString()}`;
      const newSession = createChatSession("Current Chat");
      chatSessions.unshift(newSession);
      setActiveSession(newSession.id);
      renderChatHistoryOptions();
      renderActiveSessionMessages();
    }

    function renderChatHistoryOptions() {
      chatHistorySelect.innerHTML = "";
      chatSessions.forEach((session) => {
        const option = document.createElement("option");
        option.value = session.id;
        option.textContent = session.label;
        if (session.id === activeSessionId) {
          option.selected = true;
        }
        chatHistorySelect.append(option);
      });
    }

    function setActiveSession(sessionId) {
      const session = getSessionById(sessionId);
      activeSessionId = session.id;
      conversationHistory = session.history;
    }

    function getSessionById(sessionId) {
      const session = chatSessions.find((item) => item.id === sessionId);
      if (typeof session === "undefined") {
        throw new Error(`chat session not found: ${sessionId}`);
      }
      return session;
    }

    function getActiveSession() {
      if (activeSessionId === "") {
        throw new Error("active chat session is not set");
      }
      return getSessionById(activeSessionId);
    }

    function appendUserMessage(message) {
      addMessageToActiveSession("user", message);
    }

    function appendAssistantMessage(markdownAnswer) {
      addMessageToActiveSession("assistant", markdownAnswer);
    }

    function appendSystemError(errorText) {
      addMessageToActiveSession("error", errorText);
    }

    function addMessageToActiveSession(role, text) {
      if (typeof text !== "string") {
        throw new Error("message text must be a string");
      }
      const session = getActiveSession();
      session.messages.push({ role, text });
      renderActiveSessionMessages();
    }

    function renderActiveSessionMessages() {
      const session = getActiveSession();
      chatWindow.innerHTML = "";
      session.messages.forEach((entry) => {
        chatWindow.append(buildMessageElement(entry));
      });
      scrollChatToBottom();
    }

    function buildMessageElement(entry) {
      if (!("role" in entry) || !("text" in entry)) {
        throw new Error("chat entry must include role and text");
      }
      if (entry.role === "user") {
        return buildUserMessageElement(entry.text);
      }
      if (entry.role === "assistant") {
        return buildAssistantMessageElement(entry.text);
      }
      if (entry.role === "error") {
        return buildErrorMessageElement(entry.text);
      }
      throw new Error(`unsupported chat entry role: ${entry.role}`);
    }

    function buildUserMessageElement(message) {
      const row = document.createElement("div");
      row.className = "mb-3 flex justify-end";
      const wrapper = document.createElement("article");
      wrapper.className = "max-w-[85%] rounded-xl border border-zinc-300 bg-zinc-200/90 p-3";
      wrapper.innerHTML = `<p class="text-right text-xs font-semibold uppercase tracking-wide text-zinc-600">You</p><p class="mt-1 text-right text-sm text-zinc-900">${escapeHtml(message)}</p>`;
      row.append(wrapper);
      return row;
    }

    function buildAssistantMessageElement(markdownAnswer) {
      const row = document.createElement("div");
      row.className = "mb-3 flex justify-start";
      const wrapper = document.createElement("article");
      wrapper.className = "max-w-[85%] rounded-xl border border-red-200 bg-white p-3 shadow-sm";
      const markdownHtml = renderMarkdown(markdownAnswer);
      wrapper.innerHTML = `<p class="text-xs font-semibold uppercase tracking-wide text-red-600">Assistant</p><div class="markdown-body mt-2 text-sm text-zinc-800">${markdownHtml}</div>`;
      row.append(wrapper);
      return row;
    }

    function buildErrorMessageElement(errorText) {
      const row = document.createElement("div");
      row.className = "mb-3 flex justify-start";
      const wrapper = document.createElement("article");
      wrapper.className = "max-w-[85%] rounded-xl border border-red-300 bg-red-50 p-3";
      wrapper.innerHTML = `<p class="text-xs font-semibold uppercase tracking-wide text-red-600">Error</p><p class="mt-1 text-sm text-red-700">${escapeHtml(errorText)}</p>`;
      row.append(wrapper);
      return row;
    }

    async function loadDocuments() {
      documentsStatus.textContent = "Refreshing indexed documents...";
      const response = await fetch("/documents");
      const payload = await response.json();
      if (!response.ok) {
        documentsStatus.textContent = `Failed to load documents: ${requireString(payload, "detail", "document list error")}`;
        return;
      }
      if (!("documents" in payload) || !Array.isArray(payload.documents)) {
        throw new Error("missing 'documents' array in document list response");
      }
      renderDocuments(payload.documents);
    }

    function renderDocuments(documents) {
      documentsTableBody.innerHTML = "";
      if (documents.length === 0) {
        const row = document.createElement("tr");
        row.innerHTML = "<td class=\"px-4 py-6 text-sm text-zinc-500\" colspan=\"4\">No indexed documents yet.</td>";
        documentsTableBody.append(row);
        documentsStatus.textContent = "0 indexed documents.";
        return;
      }

      documents.forEach((documentRecord, index) => {
        const context = `document[${index}]`;
        const filename = requireString(documentRecord, "filename", context);
        const docId = requireString(documentRecord, "doc_id", context);
        const chunksIndexed = requireNumber(documentRecord, "chunks_indexed", context);
        const row = document.createElement("tr");
        row.className = "transition hover:bg-zinc-50";
        row.innerHTML = `
          <td class="px-4 py-3 font-medium text-zinc-900">${escapeHtml(filename)}</td>
          <td class="px-4 py-3 font-mono text-xs text-zinc-600">${escapeHtml(docId)}</td>
          <td class="px-4 py-3 text-zinc-700">${chunksIndexed.toString()}</td>
          <td class="px-4 py-3 text-right">
            <button
              class="delete-document rounded-md border border-red-300 bg-white px-2.5 py-1.5 text-xs font-semibold text-red-700 transition hover:bg-red-50"
              type="button"
              data-doc-id="${escapeHtml(docId)}"
            >
              Delete
            </button>
          </td>
        `;
        const deleteButton = row.querySelector(".delete-document");
        if (deleteButton === null) {
          throw new Error("missing delete button in document row");
        }
        deleteButton.addEventListener("click", async () => {
          await deleteDocument(docId, filename);
        });
        documentsTableBody.append(row);
      });
      documentsStatus.textContent = `${documents.length} indexed document(s).`;
    }

    async function deleteDocument(docId, filename) {
      const shouldDelete = window.confirm(`Delete '${filename}' and remove its indexed chunks?`);
      if (!shouldDelete) {
        return;
      }
      documentsStatus.textContent = `Deleting ${filename}...`;
      const response = await fetch(`/documents/${encodeURIComponent(docId)}`, {
        method: "DELETE",
      });
      const payload = await response.json();
      if (!response.ok) {
        documentsStatus.textContent = `Delete failed: ${requireString(payload, "detail", "delete document error")}`;
        return;
      }
      const chunksDeleted = requireNumber(payload, "chunks_deleted", "delete document response");
      documentsStatus.textContent = `Deleted ${filename}. Removed ${chunksDeleted} chunk(s) from index.`;
      await loadDocuments();
    }

    function escapeHtml(value) {
      return value
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll("\"", "&quot;")
        .replaceAll("'", "&#39;");
    }

    function scrollChatToBottom() {
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }
  </script>
</body>
</html>
